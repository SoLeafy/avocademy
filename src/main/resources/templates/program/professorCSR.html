<!DOCTYPE html>
<html lang="ko" data-bs-theme="auto" xmlns:th="http://www.thymeleaf.org">

<head>
  <th:block th:insert="~{./fragments.html :: headTag}"></th:block>
  <meta charset="UTF-8">
  <title>Avocado 상담</title>
  <script src="/index/assets/js/color-modes.js"></script>

  <!-- jquery CDN -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- fullcalendar CDN -->
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/main.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/main.min.js'></script>
  <!-- fullcalendar 언어 CDN -->
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/locales-all.min.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script> <!-- moment.js 로드 -->

  <style>
  
 	main {
  		display:row;
  	}
  	
  	.card {
  	width: 100%;
  	
  	}
  	
  	.mainContents {
  		margin: 0 auto;
  		height: auto;
  		min-height: 600px;
  		display: flex;
  	}
  	
    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }

    label {
      font-size: 18px;
      line-height: 2rem;
      padding: 0.2em 0.4em;
    }

    [type="radio"],
    span {
      vertical-align: middle;
    }

    [type="radio"] {
      appearance: none;
      border: max(2px, 0.1em) solid gray;
      border-radius: 50%;
      width: 1.25em;
      height: 1.25em;
      transition: border 0.5s ease-in-out;
    }

    [type="radio"]:checked {
      border: 0.4em solid tomato;
    }

    [type="radio"]:focus-visible {
      outline-offset: max(2px, 0.1em);
      outline: max(2px, 0.1em) dotted tomato;
    }

    [type="radio"]:hover {
      box-shadow: 0 0 0 max(4px, 0.2em) lightgray;
      cursor: pointer;
    }

    [type="radio"]:hover+span {
      cursor: pointer;
    }

    [type="radio"]:disabled {
      background-color: lightgray;
      box-shadow: none;
      opacity: 0.7;
      cursor: not-allowed;
    }

    [type="radio"]:disabled+span {
      opacity: 0.7;
      cursor: not-allowed;
    }
    .form-check-input:checked+.form-check-label {
      font-weight: bold;
      color: black;
    }
  </style>


  <!-- Custom styles for this template -->
  <link href="/index/carousel/carousel.css" rel="canonical">

</head>

<body>
	<main class="container">
		<th:block th:insert="~{./fragments.html :: menu}"></th:block>	
		<th:block th:insert="~{./fragments.html :: headerImg}"></th:block>

  <div class="mainContents">
		<th:block th:insert="~{./fragments.html :: counselSidebar}"></th:block>
    <div class="card">
      <form action="/professorCSR" method="post">
        <div class="card-body">
          <th:block th:each="item : ${list}">
            <h5 class="card-title mb-0">지도교수 상담 신청서</h5>
            <div class="form-group mt-3">
              <label>이름 <small class="text-muted"></small></label>
              <input type="text" class="form-control name-inputmask" id="name" name="name" onfocus="this.value"
                th:value="${item.stud_nm}" readonly>
            </div>
            <div class="form-group">
              <label>학번 <small class="text-muted"></small></label>
              <input type="text" class="form-control studentNumber-inputmask" id="studentNumber" name="studentNumber"
                onfocus="this.value" th:value="${item.stud_no}" readonly>
            </div>
            <div class="form-group">
              <label>전화번호 <small class="text-muted"></small></label>
              <input type="text" class="form-control phone-inputmask" id="phone" onfocus="this.value" name="phone"
                th:value="${item.stud_telno}" readonly>
            </div>
            
          </th:block>
          <div class="form-group">
            <label>상담 종류 <small class="text-muted">(한가지 선택해주세요)</small></label>
            <div class="card">
              <div class="form-check">
                <input type="radio" class="form-check-input" id="customControlValidation1" name="radio-stacked"
                  value="적응문제" required>
                <label class="form-check-label mb-0" for="customControlValidation1">적응문제</label>
              </div>
              <div class="form-check">
                <input type="radio" class="form-check-input" id="customControlValidation2" name="radio-stacked"
                  value="경제적 또는 현실의 문제" required>
                <label class="form-check-label mb-0" for="customControlValidation2">경제적 또는 현실의 문제</label>
              </div>
              <div class="form-check">
                <input type="radio" class="form-check-input" id="customControlValidation3" name="radio-stacked"
                  value="교우 및 대인관계" required>
                <label class="form-check-label mb-0" for="customControlValidation3">교우 및 대인관계</label>
              </div>
              <div class="form-check">
                <input type="radio" class="form-check-input" id="customControlValidation4" name="radio-stacked"
                  value="이성 및 성문제" required>
                <label class="form-check-label mb-0" for="customControlValidation4">이성 및 성문제</label>
              </div>
              <div class="form-check">
                <input type="radio" class="form-check-input" id="customControlValidation5" name="radio-stacked"
                  value="가정 문제" required>
                <label class="form-check-label mb-0" for="customControlValidation5">가정 문제</label>
              </div>
              <div class="form-check">
                <input type="radio" class="form-check-input" id="customControlValidation6" name="radio-stacked"
                  value="정서적 문제" required>
                <label class="form-check-label mb-0" for="customControlValidation6">정서적 문제</label>
              </div>
              <div class="form-check">
                <input type="radio" class="form-check-input" id="customControlValidation7" name="radio-stacked"
                  value="성격 문제" required>
                <label class="form-check-label mb-0" for="customControlValidation7">성격 문제</label>
              </div>
              <div class="form-check">
                <input type="radio" class="form-check-input" id="customControlValidation8" name="radio-stacked"
                  value="실존적 문제" required>
                <label class="form-check-label mb-0" for="customControlValidation8">실존적 문제</label>
              </div>
              <div class="form-check">
                <input type="radio" class="form-check-input" id="customControlValidation9" name="radio-stacked"
                  value="학업 및 진로상담" required>
                <label class="form-check-label mb-0" for="customControlValidation9">학업 및 진로상담</label>
              </div>
              <div class="form-check">
                <input type="radio" class="form-check-input" id="customControlValidation10" name="radio-stacked"
                  value="정신건강, 행동 및 습관의 문제" required>
                <label class="form-check-label mb-0" for="customControlValidation10">정신건강, 행동 및 습관의 문제</label>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>추가상담내용 <small class="text-muted">(있다면 구체적으로)</small></label>
            <div class="">
              <textarea class="form-control" name="content" placeholder="내용을 입력하세요."></textarea>
            </div>
          </div>

          <!-- calendar 태그 -->
          <div id='calendar-container'>
            <div id='calendar'></div>
          </div>

          <!-- 콜랩스 -->
          <div class="collapse" id="eventDetails">
            <div class="card card-body">
              <h5 id="eventTitle">상담시간선택</h5>
              <p id="eventDate"></p>
              <div id="selectedTime">
                <!-- 자바스크립트로 생성된 라디오 버튼들 여기 들어가여 -->
              </div>
              <input type="hidden" id="selectedDate" name="selectedDate">
              <input type="hidden" id="selectedPscNo" name="selectedPscNo">
              
            </div>
          </div>

        </div>
        <div class="border-top">
          <div class="card-body">
            <button type="submit" class="btn btn-secondary">신청하기</button>
          </div>
        </div>
      </form>
    </div>
    
    <!-- Confirmation Modal -->
	<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="confirmationModalLabel">상담 신청 확인</h5>
	      </div>
	      <div class="modal-body">
	      	<th:block th:each="item1 : ${list}">
	        <p>이름: <span th:text="${item1.stud_nm}"></span></p>
	        <p>학번: <span th:text="${item1.stud_no}"></span></p>
	        </th:block>
	        <p>선택한 날짜: <span id="modalSelectedDate"></span></p>
	        <p>선택한 시간: <span id="modalSelectedTime"></span></p>
	        <p>상담을 신청하시겠습니까?</p>
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
	        <button type="button" class="btn btn-primary" id="finalSubmitButton">신청</button>
	      </div>
	    </div>
	  </div>
	</div>
    
    
  </div>
		<!-- 본문 끝 -->
	</main>
	<!-- FOOTER -->
	<th:block th:insert="~{./fragments.html :: footer}"></th:block>
</body>


<script>
  (function () {
    $(function () {
      // calendar element 취득      
      var calendarEl = $('#calendar')[0];
      
      var events = [];
      
    	  
      // full-calendar 생성하기      
      var calendar = new FullCalendar.Calendar(calendarEl, {
        height: '400px', // calendar 높이 설정        
        expandRows: true, // 화면에 맞게 높이 재설정        
        //slotMinTime: '09:00', // Day 캘린더에서 시작 시간        
        //slotMaxTime: '17:50', // Day 캘린더에서 종료 시간        
        // 해더에 표시할 툴바        
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek'
        },
        
        initialView: 'dayGridMonth', // 초기 로드 될때 보이는 캘린더 화면(기본 설정: 달)        
        //initialDate: '2021-07-15', // 초기 날짜 설정 (설정하지 않으면 오늘 날짜가 보인다.)        
        navLinks: false, // 날짜를 선택하면 Day 캘린더나 Week 캘린더로 링크        
        editable: true, // 수정 가능?        
        selectable: false, // 달력 일자 드래그 설정가능        
        //nowIndicator: true, // 현재 시간 마크        
        //dayMaxEvents: true, // 이벤트가 오버되면 높이 제한 (+ 몇 개식으로 표현)        
        locale: 'ko', // 한국어 설정        
        fixedWeekCount: false, // 해당 달에 포함된 일주일 외 저번 달이나 다음 달의 주는 표시되지 않게 하기

        // 과거 날짜 없애버리기~! & 오늘부터 한달까지만 보이게하기
        validRange: {
          start: Date.now(),
          end: Date.now() + 2592000000,
        },
		
        dateClick: function (info) {
          var selectedDate = info.dateStr; // 클릭한 날짜 정보 획득

          var selectedTime;
          // 해당 날짜의 이벤트 정보 획득
          
          selectedDate = selectedDate.replaceAll("-", "");
          console.log(selectedDate);
			
          $('#selectedDate').val(selectedDate);

          // 날짜를 ajax로 보내 DB조회 후 시간 가져오기
          $.ajax({
            type: "post",
            url: "/timeList",
            dataType: "json",
            data: {
              "selectedDate": selectedDate
            },
            success: function (response) {
              // 콜랩스 열기
              $('#eventDetails').collapse('show');
			
              // 콜랩스 내용 갱신
              $('#eventDate').text(info.dateStr);

              // 해당 날짜에 값이 있는지 확인
              if (response.length == 0) {
                $('#selectedTime').empty(); // 기존 라디오 버튼 삭제
                $('#selectedTime').append('<p id="noDataMessage">예약 가능한 시간이 없습니다.</p>');
              } else { // 해당 날짜에 값이 있을 때
                $('#noDataMessage').remove(); // 값이 있으면 메시지 삭제
                var timeList = response; // AJAX 응답으로 받은 시간 목록
                var radioGroup = $('#selectedTime'); // 라디오 버튼 그룹을 담을 div
                radioGroup.empty(); // 기존 라디오 버튼 삭제
                
                $.each(timeList, function (index, time) {
                  // 각 시간별 라디오 버튼 생성
                  var radioId = 'time' + index; // 유니크한 ID 생성
                  var radioBtn = $('<input type="radio" class="form-check-input" name="selectedTime" value="' + time.psc_hr + '" id="' + radioId + '" required>');
                  var label = $('<label class="form-check-label" for="' + radioId + '"><span>' + time.hr_nm + '</span></label>');
                  
                  
                  radioBtn.on('change', function() {
                	 $('#selectedPscNo').val(time.psc_no); // hidden input에 psc_no값 넣어주기 
                  });
                  
                  radioGroup.append(radioBtn);
                  radioGroup.append(label);
                  radioGroup.append('<br>');
                });
              }
            	
            },

            error: function (xhr, status, error) {
              console.log('ajax에러 : ', status, error);
            }
          });

        }
      });
      // 캘린더 랜더링      
      calendar.render();
		
      // 최종으로 물어보는 모달
      $('form').on('submit', function (event) {
          event.preventDefault();
          $('#modalSelectedDate').text($('#eventDate').text());
          $('#modalSelectedTime').text($('input[name="selectedTime"]:checked').next('label').text());
          $('#confirmModal').modal('show');
        });
      
      $('.modal-footer .btn-secondary').click(function() {
          $('#confirmModal').modal('hide');
      });

        // 모달에서 최종 신청 버튼 클릭 시 폼 제출
        $('#finalSubmitButton').on('click', function () {
        	
        	var selectedDate = $('#selectedDate').val();
            var selectedTime = $('input[name="selectedTime"]:checked').val();
        	
            
        	
        	// 해당 날짜, 해당 시간에 다른 스케쥴이 존재하는지 조회
        	$.ajax ({
        		type: "post",
        		url: "/checkSchedule",
        		dataType: "json",
        		data: {
        			"selectedDate" : selectedDate,
        			"selectedTime" : selectedTime
        		},
        		success : function (response) {
          			
        			if(response == 0) {
        			$('form')[0].submit();
        			alert("상담이 예약되었습니다.")
        			
        		} else {
        			alert("이미 예약된 다른 상담 일정이 있습니다.");
        			$('#confirmationModal').modal('hide');
        		}
        		},
        		error : function (error) {
        			alert("일정을 다시 확인해주세요.");
        		}
        	})
        	
        });
    	 
    });
  })();

</script>

</html>